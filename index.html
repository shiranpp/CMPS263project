<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>When and Where can i buy a house in Beijing</title>
</head>
<link rel="stylesheet" href="css/tether.min.css">
<link rel="stylesheet" href="css/bootstrap.min.css">
<style>
    .container {
        position: relative;
        top: 25%;
        left: 0%;
    }

    a {
        font-family: Helvetica, sans-serif;
        font-size: 16px;
        color: #000;
    }

    .legend {
        background-color: #ffffff;
        border-style: solid;
        border-color: #449999;
        border-width: 1px;
    }

    text {
        font-family: Helvetica, sans-serif;
        font-size: 8px;
        color: #000;
    }

    h1 {
        font-family: Helvetica, sans-serif;
        font-size: 28px;
        color: #000;
    }

    h2 {
        font-family: Helvetica, sans-serif;
        font-size: 18px;
        color: #000;
    }

    svg.district {
        position: absolute;
        top: 240px;
        left: 0px;
        height: 600px;
        width: 800px;
        bottom: 100px;
        margin-left: auto;
        margin-right: 2px;
        right: 0;
        border-style: solid;
        border-color: #449999;
        border-width: 1px;
    }

    div.title {
        height: 200px;
        padding: 4px;
        background-color: #ddd;
        border-bottom: 2px solid #ccc;
        padding: 4px;
    }

    .tooltip {
        position: absolute;
        font-family: simsun;
        font-size: 16px;
        text-align: center;
        padding: 1em;
        background: #903030;
        border: 1px solid #dddddd;
        color: #ffffff;
    }
</style>
<script type="text/javascript" src="http://cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
<script type="text/javascript" src="js/tether.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" src="http://d3js.org/topojson.v1.min.js"></script>
<script type="text/javascript" src="js/chroma.min.js"></script>
<body>
<div class="title">
    <div class="container">
        <h1 style="text-align:center">When and Where can i buy a house in Beijing ?</h1>
        <h1 style="text-align:center">那么！在北京何时才能买到我想要的房子呢？</h1>
        <h2 style="text-align:center">Ziqiang Wang, Ran(Ryan) Shi, Zhuo Wang</h2>
    </div>
</div>
<br>
<div class="map" id="map">
    <div class="btn-group">
        <button id="wagetype0" type="button" class="btn btn-primary"
        ">Job title(职位):
        </button>
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
        </button>
        <ul id="wgmenu" class="dropdown-menu" role="menu">
        </ul>
    </div>
    <br>
    <br>
    <a>OR(或)</a>
    <br>
    <br>
    <div class="input-group">
        <button id="wagetype1" type="button" class="btn btn-primary">Fixed
            wages/Month(每月固定工资):¥
        </button>
        <div>
            <input id="avgwage_input" type="number" class="form-control" name="msg" placeholder="0"
                   style="width:200px;//宽度height=20px;//高度" onchange="changeAvgWage()">
        </div>
    </div>
    <br>
    <a>And(和)</a>
    <br>
    <br>
    <div class="btn-group">
        <button type="button" class="btn btn-primary">Apartment area type(房屋面积类型):</button>
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li id="aitem1" class="aitem" onclick="changrArea(50,1)" style="background-color:#0bb7ba "><a>Around
                50/m<sup>2</sup></a></li>
            <li id="aitem2" class="aitem" onclick="changrArea(70,2)"><a>Around 70/m<sup>2</sup></a></li>
            <li id="aitem3" class="aitem" onclick="changrArea(90,3)"><a>Around 90/m<sup>2</sup></a></li>
            <li id="aitem4" class="aitem" onclick="changrArea(110,4)"><a>Around 110/m<sup>2</sup></a></li>
        </ul>
    </div>
</div>
<script>
    //Util
    var tomoney = function (m, n, x) {
        var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\.' : '$') + ')';
        return m.toFixed(Math.max(0, ~~n)).replace(new RegExp(re, 'g'), '$&,');
    };
    function cuberoot(x) {
        var y = Math.pow(Math.abs(x), 1 / 3);
        return x < 0 ? -y : y;
    }

    function solveCubic(a, b, c, d) {
        if (Math.abs(a) < 1e-8) { // Quadratic case, ax^2+bx+c=0
            a = b;
            b = c;
            c = d;
            if (Math.abs(a) < 1e-8) { // Linear case, ax+b=0
                a = b;
                b = c;
                if (Math.abs(a) < 1e-8) // Degenerate case
                    return [];
                return [-b / a];
            }

            var D = b * b - 4 * a * c;
            if (Math.abs(D) < 1e-8)
                return [-b / (2 * a)];
            else if (D > 0)
                return [(-b + Math.sqrt(D)) / (2 * a), (-b - Math.sqrt(D)) / (2 * a)];
            return [];
        }

        // Convert to depressed cubic t^3+pt+q = 0 (subst x = t - b/3a)
        var p = (3 * a * c - b * b) / (3 * a * a);
        var q = (2 * b * b * b - 9 * a * b * c + 27 * a * a * d) / (27 * a * a * a);
        var roots;

        if (Math.abs(p) < 1e-8) { // p = 0 -> t^3 = -q -> t = -q^1/3
            roots = [cuberoot(-q)];
        } else if (Math.abs(q) < 1e-8) { // q = 0 -> t^3 + pt = 0 -> t(t^2+p)=0
            roots = [0].concat(p < 0 ? [Math.sqrt(-p), -Math.sqrt(-p)] : []);
        } else {
            var D = q * q / 4 + p * p * p / 27;
            if (Math.abs(D) < 1e-8) {       // D = 0 -> two roots
                roots = [-1.5 * q / p, 3 * q / p];
            } else if (D > 0) {             // Only one real root
                var u = cuberoot(-q / 2 - Math.sqrt(D));
                roots = [u - p / (3 * u)];
            } else {                        // D < 0, three roots, but needs to use complex numbers/trigonometric solution
                var u = 2 * Math.sqrt(-p / 3);
                var t = Math.acos(3 * q / p / u) / 3;  // D < 0 implies p < 0 and acos argument in [-1..1]
                var k = 2 * Math.PI / 3;
                roots = [u * Math.cos(t), u * Math.cos(t - k), u * Math.cos(t - 2 * k)];
            }
        }

        // Convert back from depressed cubic
        for (var i = 0; i < roots.length; i++)
            roots[i] -= b / (3 * a);

        return roots;
    }

    //wage
    jobs = [{
        "factor": [-100.153656786315, 5739.131933242013, 128036.35976415545, -98049.75935048718],
        "title": "SDE/Network average(\u8f6f\u4ef6/\u7f51\u7edc\u5e73\u5747)"
    }, {
        "factor": [-71.91894847623357, 4166.503072999137, 52976.56069407518, -24431.754789274957],
        "title": "Website editor(\u7f51\u7ad9\u7f16\u8f91)"
    }, {
        "factor": [-89.9802155781023, 5185.700674310238, 202162.8783050057, -97184.20580186293],
        "title": "Senior product manager(\u9ad8\u7ea7\u4ea7\u54c1\u7ecf\u7406)"
    }, {
        "factor": [-67.5670788733333, 3859.530644151386, 101026.79915495116, -69542.6572705725],
        "title": "Electronic/Electrical/Communication average(\u7535\u5b50/\u7535\u5668/\u901a\u4fe1\u5e73\u5747)"
    }, {
        "factor": [-31.935455781395493, 1838.0642031309312, 60402.87110337462, -22090.272577997814],
        "title": "Maintenance engineer(\u7ef4\u4fee\u5de5\u7a0b\u5e08)"
    }, {
        "factor": [-99.49752437238469, 5702.309243716329, 141271.81047591259, -136122.45210728238],
        "title": "Technical engineers(\u7814\u53d1\u5de5\u7a0b\u5e08)"
    }];

    //Color Scaling range
    var scale = chroma.scale(['#1FB469', '#A94B36']);

    //Graph Setting
    var width = 800;
    var height = 600;
    var center = [116.41667, 40.21667];
    //div width
    var m_width = $("#map").width();

    var isZoomed = false;
    var district;

    var tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0.0);

    //Wage
    var wage = jobs[0].factor;
    function changeWage(i, j) {
        $("#wagetype1").css("background-color", "#0275d8")
        $("#wagetype0").css("background-color", "#0bb7ba")
        wage = i;
        $("li.wgitem").css("background-color", "#ffffff")
        $("#wgitem" + j.toString()).css("background-color", "#0bb7ba");
        rander();
    }
    function changeAvgWage() {
        $("#wagetype0").css("background-color", "#0275d8")
        $("#wagetype1").css("background-color", "#0bb7ba")
        wage = [0, 0, Number($("#avgwage_input").val()) * 12, 0];
        $("li.wgitem").css("background-color", "#ffffff")
        rander();
    }
    var area = 50;
    function changrArea(i, j) {
        $("li.aitem").css("background-color", "#ffffff")
        $("#aitem" + j.toString()).css("background-color", "#0bb7ba");
        area = i;
        rander();
    }
    //lengend
    var linear = d3.scale.linear()
        .domain([0, 150])
        .range([0, 1]);
    //    Draw map
    //    -----------------------------------------------------------------------------------------------
    var projection = d3.geo.mercator()
        .center(center)
        .scale(10000)
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    for (i in jobs) {
        console.log(jobs[i].factor.toString())
        $("#wgmenu").append(' <li id="wgitem' + i + '" class="wgitem" onclick="changeWage([' + jobs[i].factor.toString() + '],' + i + ')"><a>' + jobs[i].title + '</a></li>');
    }

    var svg = d3.select("#map").append("svg")
        .attr("class", "district")
        .attr("preserveAspectRatio", "xMidYMid")
        .attr("viewBox", "0 0 " + width + " " + height)
        .attr("width", m_width)
        .attr("height", m_width * height / width);

    svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height)
        .attr("fill", "white")
        .on("click", district_clicked);


    var g = svg.append("g");
    function canyear(price) {
        var ans = solveCubic(wage[0], wage[1], wage[2], wage[3] - price * area);
        var min = 70;
        for (num in ans) {
            if (ans[num] > 0)
                min = Math.min(min, ans[num]);
        }
        return min;
    }
    function rander() {

        d3.json("beijing1.json", function (error, root) {
            g.selectAll("path").remove();
            g
                .attr("id", "district")
                .selectAll("path")
                .data(root.features)
                .enter()
                .append("path")
                .attr("id", function (d) {
                    return d.id;
                })
                .attr("stroke", "#000")
                .attr("stroke-width", 0.5)
                .attr("fill", function (d, i) {
                    if (d.properties.avg_price == 0)
                        return scale(1).hex();
                    ;
<<<<<<< HEAD
                    return scale(Math.max(0, Math.min(30, (canyear(d.properties.avg_price) - 10) / 30))).hex();
=======
                    return scale(Math.max(0, Math.min(30, (canyear(d.properties.avg_price) - 10) / 20))).hex();
>>>>>>> master
                })
                .style("opacity", 0.9)
                .attr("d", path)
                .on("click", district_clicked)
                .on("mouseover", function (d, i) {
                    if (!isZoomed) {
                        d3.select(this)
                            .style("opacity", 0.7);
                        tooltip.html(d.properties.name + ((d.properties.avg_price==0)?"<br>unavailable(无信息)":("<br>Price(价格):¥" + tomoney(d.properties.avg_price, 2).toLocaleString("en-us") + " /m<sup>2</sup><br>Cost(花费):" + ((Number(canyear(d.properties.avg_price)) >= 70) ? '>70' : Number(canyear(d.properties.avg_price)).toFixed(2)) + " year(年)")))
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY + 10) + "px")
                            .style("opacity", 1.0);
                    } else {
                        d3.select(this)
                            .style("opacity", 0.9);
                    }
                }).on("mousemove", function (d) {
                if (!isZoomed) {
                    tooltip.html(d.properties.name + ((d.properties.avg_price==0)?"<br>unavailable(无信息)":("<br>Price(价格):¥" + tomoney(d.properties.avg_price, 2).toLocaleString("en-us") + " /m<sup>2</sup><br>Cost(花费):" + ((Number(canyear(d.properties.avg_price)) >= 70) ? '>70' : Number(canyear(d.properties.avg_price)).toFixed(2)) + " year(年)")))
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY + 10) + "px")
                } else {
                    d3.select(this)
                        .style("opacity", 0.9);
                }

            })
                .on("mouseout", function (d, i) {
                    tooltip.html("").style("opacity", 0.0);
                    d3.select(this)
                        .style("opacity", 0.9);
                });

        });
        var legend = svg.append("g")
            .attr("class", "lenged");
        legend.selectAll("rect")
            .data(d3.range(150))
            .enter()
            .append("rect")
            .attr("y", function (d, i) {
                return 15;
            })
            .attr("x", function (d, i) {
                return Math.floor(i / 15) * 15 + 30;
            })
            .attr("width", 20)
            .attr("height", 20)
            .style("fill", function (d) {
                return scale(linear(d));
            });

        legend.selectAll("text")
            .data(["<10 Year", "20 years", ">30 years"])
            .enter()
            .append("text")
            .attr("x", function (d, i) {
                return 10 + i * 75;
            })
            .attr("y", 50)
            .text(function (d) {
                return d;
            });
    }
    rander();

    //Get coodinate for zoom in
    function get_xyz(d) {
        var bounds = path.bounds(d);
        var w_scale = (bounds[1][0] - bounds[0][0]) / width;
        var h_scale = (bounds[1][1] - bounds[0][1]) / height;
        var z = .9 / Math.max(w_scale, h_scale);
        var x = (bounds[1][0] + bounds[0][0]) / 2;
        var y = (bounds[1][1] + bounds[0][1]) / 2;
        return [x, y, z];
    }
    ;

    //Click action for district map

    function district_clicked(d) {
        if (district) {
            g.selectAll("#" + district.id).style('display', null);
        }
        if (d && district == null) {
            tooltip.html("").style("opacity", 0.0);
            isZoomed = true;
            var xyz = get_xyz(d);
            district = d;
            zoom(xyz);
        } else {
            if (district != d) {
                isZoomed = false;
                var xyz = [width / 2, height / 2, 1];
                district = null;
                zoom(xyz);
            }
        }
    }
    ;
    //zoomin
    function zoom(xyz) {
        g.transition()
            .duration(750)
            .attr("transform", "translate(" + projection.translate() + ")scale(" + xyz[2] + ")translate(-" + xyz[0] + ",-" + xyz[1] + ")")
            .selectAll(["#countries", "#states", "#cities"])
            .style("stroke-width", 1.0 / xyz[2] + "px")
            .selectAll(".city")
            .attr("d", path.pointRadius(20.0 / xyz[2]));
    }
    ;
    //    -----------------------------------------------

</script>

</body>
</html>
